---
layout: post
title: 시멘틱 캐시
tags: [시멘틱캐시,AI]
use_math: false
---



『요즘 당근 AI』라는 책에서 눈여겨 내용은 여러개가 있는데 그 중 하나가 ‘시맨틱 캐시’ 의 적용이다. 

당근 앱에서는 채팅에서 ‘AI추천 메시지’라는 기능이 있다. 

![image-20260203111209894](C:\Users\cheuo\work\cheuora.github.io\_posts\2026\assets\image-20260203111209894.png)

이전에는 마지막 메시지를 LLM에 던져 추천 문장을 받았다고 한다. 이렇게 되면 두 가지 문제가 발생을 하는데

1. LLM의 응답을 기다려야 하는 점(속도가 느리다)
2. LLM 사용 토큰 비용 



특히 토큰 비용을 추정을 해 보았는데, 당근 시스템에서는 1년에 약 1000만건의 메시지가 오고가고 있으며 이를 위한 추천 토큰 비용을 추정해 보니 약 8억 ~ 9억원 정도에 달한다고 한다. 

이 문제점들을 완화하기 위해 당근에서 생각했던 것이 바로 “시맨틱 캐시(Symantic cache)” 라는 것이다. 

추천 문장들을 캐싱해 놓고 LLM으로 던지기 전에 캐시를 먼저 뒤져서 Hit하면 이를 보여주는 개념인데 다음 그림을 참조 하기 바란다. 

![](C:\Users\cheuo\work\cheuora.github.io\_posts\2026\assets\image-20260120142800112.png)

시맨틱 캐싱의 기본 원리는 매칭 기준을 ‘유사도’ 기준으로 판단한다는 것이다. 이를 위해 시맨틱 캐싱에 사용되는 저장소는 벡터DB로 구성한다. 글쓴이는 chromem_go 를 메모리에 올려 사용했지만, 벡터 DB중 온메모리로 사용가능한 것이면 어떤것이든 상관없다. 

캐싱 구조라면 1번 속도 문제 해결에는 도움이 될 것 같다. 그럼 2번 비용 문제는 얼마나 도움이 될 까?

당근 앱에서 오가는 채팅 메시지가 약 1000만건 정도 된다고 한다. 캐싱 미사용시 하루에 들어가는 사용 비용은

**9억원(연간LLM예상 비용) ÷ 365일 = 2,465,000원** 

캐싱을 사용하고 캐시 HIT가 100%라고 가정을 하면 들어가는 비용은... **1400원** 정도로 예측된다.

![](C:\Users\cheuo\work\cheuora.github.io\_posts\2026\assets\image-20260120143611124.png)



시스템에서 현실적으로 ‘캐시HIT 100%’ 가 나오기는 힘들다. 캐시HIT율을 기반으로 개략적인 비용을 계산해 보니 다음과 같았다.

![](C:\Users\cheuo\work\cheuora.github.io\_posts\2026\assets\image-20260120144254344.png)



시맨틱 캐시 구성은 다음과 같이 했다. 



![](C:\Users\cheuo\work\cheuora.github.io\_posts\2026\assets\image-20260120144752933.png)

메인 서버와는 분리된 애드온(Add On)형태이며 통신은 gRPC를 썼다고 한다.

벡터DB에 문장 1000개를 저장해도 메모리는 6MB에 불과하며 이에 대한 전수 탐색시 평균 2㎳내였다. 성능면에서는 나쁘지 않지만 임베딩 생성과정에서 여전히 병목이 발생했다고 한다.

* 평균 400~800㎳
* 이에 대응하기 위해 k8s에서 리플리카를 만들어 수평 확장 전략 사용
* 리플리카가 초당 100~120건을 처리하며 어느정도 속도가 올라감



임베딩 모델 서비스에서도 문제가 있었다. 하나의 문장이 1500여개의 고차원 벡터로 표현되는 경우가 있는데,  임베딩 과정에서 상당히 병목이 발생하는 원인이었다. 

이의 해결을 위해 이 팀에서는 **‘주성분 분석’** 이라는 차원 축소 기법을 활용해 1500개의 차원을 50여개로 줄여 이를 해결하였다. 
벡터 간의 분포를 클러스터링 시 보통 K-means가 많이 사용되고 있는데, 이 캐싱 시스템에서는 k값을 미리 알 수가 없기 때문에 적용하기는 어렵다. 그래서 여기에서는 DBSCAN 기법을 선택했다. 군집의 갯수를 미리 알 수가 없기 때문이며, 노이즈에 강하다는 장점도 있다. 



이제 이 시스템을 통한 성과를 분석해 봤다

먼저 캐시 HIT율을 조사해 보았다. 

